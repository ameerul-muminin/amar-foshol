# A3.1: Weather API Integration

## Overview

A3.1 implements the Open-Meteo weather API integration for fetching hyper-local 5-day weather forecasts for all Bangladesh divisions and districts.

## Implementation Details

### 1. Type Definitions (`src/types/weather.ts`)

Defines all TypeScript interfaces for weather data:

- **WeatherForecast**: Single day forecast with temperature, humidity, and rain probability
- **WeatherData**: Complete forecast package with location and lastUpdated timestamp
- **WeatherAdvisory**: Advisory message type structure (warning/info/success)
- **OpenMeteoResponse**: Raw API response structure from Open-Meteo
- **LocationCoordinates & DivisionsData**: Location data structures

### 2. Location Data (`src/lib/locations.ts`)

Contains comprehensive Bangladesh locations database:

- **8 Divisions**: ঢাকা (13), চট্টগ্রাম (10), খুলনা (9), বরিশাল (6), সিলেট (4), রাজশাহী (8), রংপুর (8), ময়মনসিংহ (4)
- **62 Districts**: All districts with precise GPS coordinates (accurate to 4 decimal places)
- **Helper Functions**:
  - `getDistrictCoordinates()`: Get lat/lon for any district
  - `getDivisions()`: Get list of all divisions
  - `getDistrictsByDivision()`: Get districts in a division

### 3. Weather API Service (`src/lib/weather-api.ts`)

Main weather integration module:

**Key Features:**
- Fetches 5-day forecasts from Open-Meteo (free, no API key required)
- Built-in caching (30-minute TTL to minimize API calls)
- Error handling and logging
- Data transformation to our internal format
- Timezone: Asia/Dhaka

**Core Functions:**
- `fetchWeatherForecast(latitude, longitude)`: Main fetch function
- `clearWeatherCache()`: Manual cache clearing
- `getWeatherCacheStats()`: View cache status

**API Parameters:**
```
Base URL: https://api.open-meteo.com/v1/forecast

Query Parameters:
- latitude: Location latitude
- longitude: Location longitude
- daily: temperature_2m_max, temperature_2m_min, precipitation_probability_max, relative_humidity_2m_max
- forecast_days: 5
- timezone: Asia/Dhaka
```

### 4. API Route (`src/app/api/weather/route.ts`)

Next.js API endpoint for frontend consumption:

```
GET /api/weather?division=ঢাকা&district=ঢাকা
```

**Response:**
```json
{
  "location": {
    "latitude": 23.8103,
    "longitude": 90.4125,
    "timezone": "Asia/Dhaka"
  },
  "forecasts": [
    {
      "date": "2025-11-27",
      "tempMax": 32,
      "tempMin": 25,
      "humidity": 85,
      "rainProbability": 70
    },
    ...
  ],
  "lastUpdated": "2025-11-27T10:30:00.000Z"
}
```

### 5. Bangla Number Conversion (`src/lib/bangla-numbers.ts`)

Utilities for displaying numbers in Bangla (Bengali numerals):

**Functions:**
- `toBanglaNumber(num)`: Convert 123 → "१२३"
- `toEnglishNumber(bn)`: Convert "१२३" → "123"
- `formatTemperatureBn(32)`: Format as "३२°से"
- `formatPercentageBn(85)`: Format as "८५%"
- `formatDateBn(date)`: Format as "१५ जनवरी"
- `formatDateFullBn(date)`: Format as "१५ जनवरी, २०२५"

## Usage Examples

### Backend - Fetch Weather

```typescript
import { fetchWeatherForecast } from '@/lib/weather-api';
import { getDistrictCoordinates } from '@/lib/locations';

// Get coordinates for a district
const coords = getDistrictCoordinates('ঢাকা', 'ঢাকা');

// Fetch weather
const weather = await fetchWeatherForecast(coords.lat, coords.lon);

console.log(weather.forecasts[0]); // First day forecast
```

### Frontend - Call API Route

```typescript
const response = await fetch(
  '/api/weather?division=ঢাকা&district=ঢাকা'
);
const data = await response.json();
console.log(data.forecasts);
```

### Display Numbers in Bangla

```typescript
import { toBanglaNumber, formatTemperatureBn } from '@/lib/bangla-numbers';

const temp = 32;
console.log(formatTemperatureBn(temp)); // Output: "३२°से"

const rainfall = 85;
console.log(toBanglaNumber(rainfall)); // Output: "८५"
```

## Files Created

```
src/
  types/
    weather.ts                 # Type definitions
  lib/
    weather-api.ts            # Open-Meteo integration
    locations.ts              # Bangladesh coordinates
    bangla-numbers.ts         # Number formatting
    weather-test.ts           # Test utilities
  app/
    api/
      weather/
        route.ts              # API endpoint
```

## Testing

A test utility is provided in `src/lib/weather-test.ts`:

```typescript
import { runWeatherTest } from '@/lib/weather-test';

await runWeatherTest();
```

This verifies:
1. Locations database integrity
2. Open-Meteo API connectivity
3. Data transformation
4. Cache functionality

## Performance Optimizations

1. **Caching**: 30-minute cache prevents redundant API calls
2. **Response Caching**: API route has HTTP cache headers (5min public, 10min stale)
3. **Efficient Data Structure**: Minimal payload with only essential weather data
4. **TypeScript**: Full type safety prevents runtime errors

## Error Handling

- Missing division/district parameters → 400 error
- Invalid coordinates → 400 error with clear message
- Open-Meteo API errors → 500 error with details
- All errors are logged for debugging

## Next Steps (A3.2-A3.4)

This A3.1 implementation provides the foundation for:

- **A3.2**: Weather Display UI (Bangla 5-day forecast)
- **A3.3**: Smart Advisories (conditional logic based on conditions)
- **A3.4**: Weather Caching to IndexedDB (for offline support via localforage)

## API Documentation

### Open-Meteo API (Free, No Auth Required)

Documentation: https://open-meteo.com/en/docs

**Daily Parameters Used:**
- `temperature_2m_max`: Maximum daily temperature
- `temperature_2m_min`: Minimum daily temperature
- `precipitation_probability_max`: Maximum rain probability
- `relative_humidity_2m_max`: Maximum humidity

**Timezone:** Asia/Dhaka (UTC+6)

## Notes

- All coordinates are accurate to 4 decimal places (~10 meters precision)
- Bangladesh has 8 divisions and 64 districts
- Weather API calls should be rate-limited (currently not enforced, rely on caching)
- Open-Meteo provides free weather data without API key requirement
